<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SchoolMeals - Access Healthy Meals</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
    .header{background:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header h1{color:#333;font-size:2em;display:flex;align-items:center;gap:10px}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .hero{background:#fff;border-radius:20px;padding:40px;margin:20px 0;text-align:center}
    .hero h2{color:#333;font-size:2.5em;margin-bottom:20px}
    .hero p{color:#666;font-size:1.2em;margin-bottom:30px}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:15px 40px;border-radius:50px;font-size:1.1em;font-weight:600;cursor:pointer;transition:transform .3s ease}
    .btn-primary:hover{transform:translateY(-2px)}
    .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:40px 0}
    .feature-card{background:#fff;border-radius:15px;padding:30px;text-align:center;transition:transform .3s ease}
    .feature-card:hover{transform:translateY(-5px)}
    .feature-icon{font-size:3em;margin-bottom:20px}
    .feature-card h3{color:#333;margin-bottom:15px;font-size:1.3em}
    .feature-card p{color:#666;line-height:1.6}
    .intake-form{background:#fff;border-radius:20px;padding:40px;margin:40px 0;display:none}
    .intake-form.active{display:block}
    .form-group{margin-bottom:25px}
    .form-group label{display:block;color:#333;font-weight:600;margin-bottom:8px}
    .form-group input,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;transition:border-color .3s ease}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:#667eea}
    .progress-bar{height:6px;background:#e0e0e0;border-radius:3px;margin:30px 0;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:3px;transition:width .5s ease}
    .sites-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px;margin:20px 0}
    .site-card{background:#fff;border-radius:15px;padding:20px;border:2px solid transparent;transition:all .3s ease}
    .site-card:hover{border-color:#667eea;transform:translateY(-2px)}
    .site-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:15px}
    .site-name{color:#333;font-size:1.2em;font-weight:600}
    .site-distance{color:#667eea;font-weight:600}
    .site-details{color:#666;line-height:1.6}
    .site-features{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
    .site-feature{background:#f0f0f0;padding:5px 10px;border-radius:15px;font-size:.9em;color:#555}
    .status-message{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:15px;border-radius:8px;margin:20px 0}
    .error-message{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24;padding:15px;border-radius:8px;margin:20px 0}
    .loading{text-align:center;padding:40px}
    .spinner{border:3px solid rgba(0,0,0,.1);border-top-color:#667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .impact-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}
    .metric-card{background:#fff;border-radius:15px;padding:25px;text-align:center}
    .metric-value{font-size:2.5em;font-weight:700;color:#667eea}
    .metric-label{color:#666;margin-top:10px}
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>üçé SchoolMeals <span style="font-size:.5em;color:#666;">Powered by A2A</span></h1>
    </div>
  </div>

  <div class="container">
    <!-- Hero -->
    <div class="hero" id="heroSection">
      <h2>Access Healthy Meals for Your Family</h2>
      <p>Free and reduced-price meals for eligible families.<br/>No judgment, just support. Let's get started.</p>
      <button class="btn-primary" onclick="startIntake()">Get Started ‚Üí</button>
    </div>

    <!-- Features -->
    <div class="features" id="featuresSection">
      <div class="feature-card">
        <div class="feature-icon">üí∞</div>
        <h3>Maximize Benefits</h3>
        <p>We identify all programs you qualify for. Average family may save hundreds monthly.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üìù</div>
        <h3>Simple Application</h3>
        <p>We pre-fill what we can and guide you through the rest. Takes minutes.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üìç</div>
        <h3>Find Nearby Sites</h3>
        <p>Discover meal sites close to home, work, or school.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üìÖ</div>
        <h3>Schedule Pickups</h3>
        <p>Add pickup times to your calendar and get reminders.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üîê</div>
        <h3>Private & Secure</h3>
        <p>Your information is protected and never shared. Apply with confidence.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">üåç</div>
        <h3>Multiple Languages</h3>
        <p>Support in English, Spanish, Mandarin, and more.</p>
      </div>
    </div>

    <!-- Intake Form -->
    <div class="intake-form" id="intakeForm">
      <h2>Let's Get Started</h2>
      <p style="color:#666;margin-bottom:30px;">We'll use this information to check your eligibility and find nearby meal sites.</p>

      <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width:10%"></div></div>

      <form id="applicationForm" onsubmit="submitApplication(event)">
        <div class="form-group">
          <label for="address">Home Address</label>
          <input type="text" id="address" name="address" required placeholder="123 Main St, City, State"/>
        </div>

        <div class="form-group">
          <label for="school">School Name</label>
          <input type="text" id="school" name="school" required placeholder="Lincoln Elementary School"/>
        </div>

        <div class="form-group">
          <label for="familySize">Family Size</label>
          <select id="familySize" name="familySize" required>
            <option value="">Select...</option>
            <option value="1">1 person</option><option value="2">2 people</option>
            <option value="3">3 people</option><option value="4">4 people</option>
            <option value="5">5 people</option><option value="6">6 people</option>
            <option value="7">7 people</option><option value="8">8+ people</option>
          </select>
        </div>

        <div class="form-group">
          <label for="children">Number of Children (under 18)</label>
          <input type="number" id="children" name="children" min="1" max="10" required/>
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required placeholder="your@email.com"/>
        </div>

        <div class="form-group">
          <label for="phone">Phone Number (Optional)</label>
          <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567"/>
        </div>

        <div class="form-group">
          <label for="language">Preferred Language</label>
          <select id="language" name="language">
            <option value="en">English</option><option value="es">Espa√±ol</option>
            <option value="zh">‰∏≠Êñá</option><option value="vi">Ti·∫øng Vi·ªát</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          </select>
        </div>

        <div class="form-group">
          <label><input type="checkbox" id="snap" name="snap"/> We currently receive SNAP benefits</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="tanf" name="tanf"/> We currently receive TANF benefits</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="wic" name="wic"/> We currently receive WIC benefits</label>
        </div>

        <button type="submit" class="btn-primary" style="width:100%;">Check Eligibility ‚Üí</button>
      </form>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display:none;">
      <div class="status-message" id="eligibilityMessage">
        <h3>üéâ Great News!</h3>
        <p>Your family qualifies for meal assistance programs.</p>
      </div>

      <div class="impact-metrics">
        <div class="metric-card">
          <div class="metric-value" id="programCount">0</div>
          <div class="metric-label">Programs Available</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="monthlyValue">$0</div>
          <div class="metric-label">Est. Monthly Value</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="sitesFound">0</div>
          <div class="metric-label">Nearby Sites</div>
        </div>
      </div>

      <h3 style="margin:30px 0 20px;color:#333;">Nearby Meal Sites</h3>
      <div class="sites-grid" id="sitesGrid"></div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loadingSection" style="display:none;">
      <div class="spinner"></div>
      <p>Finding the best options for your family...</p>
    </div>
  </div>

  <script>
    let applicationData = {};

    function startIntake() {
      document.getElementById('heroSection').style.display = 'none';
      document.getElementById('featuresSection').style.display = 'none';
      document.getElementById('intakeForm').classList.add('active');
      updateProgress(10);
    }

    function updateProgress(percent) {
      document.getElementById('progressBar').style.width = percent + '%';
    }

    async function submitApplication(event) {
      event.preventDefault();
      document.getElementById('intakeForm').style.display = 'none';
      document.getElementById('loadingSection').style.display = 'block';

      const formData = new FormData(event.target);
      const children = parseInt(formData.get('children'), 10);

      // mock children ages
      const childrenAges = Array.from({ length: children }, () => Math.floor(Math.random()*17)+1);

      // Prepare payloads expected by the backend starter
      const intakePayload = {
        address: formData.get('address'),
        school: formData.get('school'),
        languages: [formData.get('language')].filter(Boolean),
        fcm_token: null
      };

      try {
        // 1) Intake
        const intakeRes = await fetch('/api/intake', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(intakePayload)
        });
        const intake = await intakeRes.json();
        if (!intake.ok) throw new Error('Intake failed');
        applicationData.family_id = intake.family_id;

        // 2) Eligibility (simple numeric income here; extend your form as needed)
        const householdSize = parseInt(formData.get('familySize'), 10);
        const income = 45000; // TODO: collect from user if needed
        const specialPrograms = [];
        if (formData.get('snap') === 'on') specialPrograms.push('SNAP');
        if (formData.get('tanf') === 'on') specialPrograms.push('TANF');
        if (formData.get('wic') === 'on') specialPrograms.push('WIC');

        const eligRes = await fetch('/api/eligibility', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            household_size: householdSize,
            income: income,
            special_programs: specialPrograms
          })
        });
        const eligibility = await eligRes.json();

        // 3) Sites (use a simple geolocate fallback; replace with real user location)
        const userLat = 40.7128, userLng = -74.0060;
        const sitesRes = await fetch(`/api/locator?lat=${userLat}&lng=${userLng}`);
        const sites = await sitesRes.json();

        displayResults(eligibility, sites, {
          email: formData.get('email'),
          familySize: householdSize,
          programsChecked: specialPrograms
        });

      } catch (err) {
        console.error(err);
        document.getElementById('loadingSection').style.display = 'none';
        const msg = document.createElement('div');
        msg.className = 'error-message';
        msg.textContent = 'An error occurred. Please try again.';
        document.querySelector('.container').prepend(msg);
      }
    }

    function displayResults(eligibility, sitesResp, context) {
      document.getElementById('loadingSection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'block';

      // Build a friendly message using the starter‚Äôs response shape
      const eligibleFlag = eligibility.eligible;
      const summary = eligibility.summary || 'Please review your district‚Äôs official guidance.';

      const programs = derivePrograms(eligibleFlag, context.programsChecked);
      const estMonthly = Math.max(0, Math.round(programs.length * 200)); // simple demo estimate

      const message = document.getElementById('eligibilityMessage');
      message.innerHTML = `
        <h3>${eligibleFlag === false ? '‚ÑπÔ∏è Heads up' : 'üéâ Great News!'}</h3>
        <p>${summary}</p>
        ${programs.length ? `<p style="margin-top:10px;"><strong>You may qualify for:</strong> ${programs.join(', ')}</p>` : ''}
        <p style="margin-top:10px;font-style:italic;">We‚Äôll help you enroll and set reminders so you never miss a pickup.</p>
      `;

      document.getElementById('programCount').textContent = programs.length.toString();
      document.getElementById('monthlyValue').textContent = `$${estMonthly}`;
      const sites = Array.isArray(sitesResp.sites) ? sitesResp.sites : [];
      document.getElementById('sitesFound').textContent = sites.length.toString();

      const sitesGrid = document.getElementById('sitesGrid');
      sitesGrid.innerHTML = sites.slice(0, 6).map(site => {
        const miles = site.distance_miles ?? '';
        const addr = site.address ?? 'See location';
        const phone = site.phone ?? '‚Äî';
        const mealTypes = site.meal_types ?? ['meals'];
        const access = (site.accessibility ?? []);
        return `
          <div class="site-card">
            <div class="site-header">
              <div class="site-name">${escapeHtml(site.name || 'Meal Site')}</div>
              <div class="site-distance">${miles ? `${miles} mi` : ''}</div>
            </div>
            <div class="site-details">
              <p>üìç ${escapeHtml(addr)}</p>
              <p>üìû ${escapeHtml(phone)}</p>
              <p>üïê ${getNextMealTime({ meal_types: mealTypes })}</p>
            </div>
            <div class="site-features">
              ${mealTypes.map(t => `<span class="site-feature">${escapeHtml(t)}</span>`).join('')}
              ${access.includes('wheelchair') ? '<span class="site-feature">‚ôø Accessible</span>' : ''}
              ${access.includes('parking') ? '<span class="site-feature">üöó Parking</span>' : ''}
            </div>
            <button class="btn-primary" style="width:100%;margin-top:15px;"
              onclick="schedulePickup('${escapeAttr(site.id || '')}', '${escapeAttr(site.name || 'Meal Site')}', '${escapeAttr(context.email)}')">
              Schedule Pickup ‚Üí
            </button>
          </div>
        `;
      }).join('');
    }

    function derivePrograms(eligible, checked) {
      // quick demo heuristic
      const base = [];
      if (eligible !== false) base.push('School Breakfast Program', 'National School Lunch Program');
      if (checked?.includes('WIC')) base.push('WIC (adjacent benefits)');
      if (checked?.includes('SNAP')) base.push('SNAP-Ed & related supports');
      return Array.from(new Set(base));
    }

    function getNextMealTime(site) {
      const now = new Date();
      const day = now.toLocaleString('en-US', { weekday: 'short' }).toLowerCase();
      if ((site.meal_types || []).includes('breakfast')) return 'Breakfast: 7:00 AM ‚Äì 8:30 AM';
      if ((site.meal_types || []).includes('lunch')) return 'Lunch: 11:30 AM ‚Äì 1:00 PM';
      return 'Check site for hours';
    }

    async function schedulePickup(siteId, siteName, email) {
      try {
        const timeIso = new Date(Date.now() + 24*3600*1000).toISOString(); // +1 day
        const res = await fetch('/api/calendar', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ email, time_iso: timeIso, site_name: siteName })
        });
        const out = await res.json();
        if (out.method === 'ics' && out.ics_file) {
          alert('‚úÖ Pickup scheduled! An ICS file was generated. Open it to add to your calendar.');
          // optionally trigger download:
          window.open(out.ics_file, '_blank');
        } else {
          alert('‚úÖ Pickup scheduled!');
        }
      } catch (e) {
        console.error('Scheduling error:', e);
        alert('Unable to schedule. Please try again.');
      }
    }

    // helpers to avoid XSS in string interpolation
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }
    function escapeAttr(str) {
      return String(str).replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // Demo helper
    function fillDemoData() {
      document.getElementById('address').value = '123 Main St, New York, NY 10001';
      document.getElementById('school').value = 'Lincoln Elementary School';
      document.getElementById('familySize').value = '4';
      document.getElementById('children').value = '2';
      document.getElementById('email').value = 'family@example.com';
      document.getElementById('snap').checked = true;
      updateProgress(30);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const demoBtn = document.createElement('button');
      demoBtn.textContent = 'Fill Demo Data';
      demoBtn.style.position='fixed';
      demoBtn.style.bottom='20px';
      demoBtn.style.right='20px';
      demoBtn.style.padding='10px 20px';
      demoBtn.style.background='#28a745';
      demoBtn.style.color='#fff';
      demoBtn.style.border='none';
      demoBtn.style.borderRadius='5px';
      demoBtn.style.cursor='pointer';
      demoBtn.onclick = fillDemoData;
      document.body.appendChild(demoBtn);
    });
  </script>
</body>
</html>
